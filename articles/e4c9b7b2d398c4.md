---
title: "QAã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã‚‹ï¼ˆvitest browser modeç·¨ï¼‰"
emoji: "ğŸ§ª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["react", "typescript", "vitest", "testing"]
published: true
---

## ã¯ã˜ã‚ã«

Reactãªã©ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ç”¨ã„ãŸãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºçµŒé¨“ã‚¼ãƒ­ã®QAã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã‚‹ã‚·ãƒªãƒ¼ã‚ºã§ã™ã€‚

èƒŒæ™¯ã¨ã—ã¦ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«å¯¾ã—ã¦ã€ã€Œãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ãã ã•ã„ã€ã¨ã‚ˆããŠé¡˜ã„ã—ã¦ã—ã¾ã„ã¾ã™ã€‚ã—ã‹ã—ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‹ã‚‰ã€Œãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã®ã§æ›¸ãæ–¹ã‚’æ•™ãˆã¦ãã ã•ã„ã€ã¨è¿”ç­”ã•ã‚Œã‚‹ã¨ã€ãã‚Œã«ç­”ãˆã‚‰ã‚Œã‚‹ã‚¹ã‚­ãƒ«ãŒãªã„ã®ã§ã€è‡ªåˆ†ãªã‚Šã«ç°¡å˜ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰ã¨ãã‚Œã‚’å¯¾è±¡ã¨ã—ãŸãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

æœ¬æ›¸ã§ã¯ã€ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚‹[vitest](https://vitest.dev/)ã®browser modeã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
ã¾ãŸã€æœ¬æ›¸ã§æ‰±ã†vitestã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯`v3.1.4`ã§ã™ã€‚

## vitest browser mode ã¨ã¯

vitestã®[browser mode](https://vitest.dev/guide/browser/)ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã‚‹ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚
[``jsdom``](https://github.com/jsdom/jsdom)ã‚„[``happy-dom``](https://github.com/capricorn86/happy-dom)ãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã€ã‚ãã¾ã§Node.jsç’°å¢ƒä¸‹ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã•ã‚ŒãŸãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã€å®Ÿéš›ã®ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã¨ã®å·®åˆ†ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã¤ã¾ã‚Šã€ã“ã‚Œã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦å¾—ã‚‰ã‚ŒãŸãƒ†ã‚¹ãƒˆçµæœã¯ã€å½é™½æ€§ã‚‚ã—ãã¯å½é™°æ€§ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨æ³¨æ„ã—ãªã„ã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
ä¸€æ–¹ã€vitestã®browser modeã§ã¯ã€å®Ÿéš›ã®ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã®ä¿¡é ¼æ€§ã‚’å‘ä¸Šã§ãã¾ã™ã€‚
ãªãŠã€`v3.1.4`ã§ã¯ã€ã¾ã experimentalãªæ©Ÿèƒ½ã§ã‚ã‚Šã€å°†æ¥çš„ã«å¤‰æ›´ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã‚‹

### ãƒ†ã‚¹ãƒˆå¯¾è±¡

ãƒ†ã‚¹ãƒˆå¯¾è±¡ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹è¦ç´ ã¨ãƒœã‚¿ãƒ³è¦ç´ ã‚’ã‚‚ã¤`InputKey`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚
å‹•ä½œã—ã‚ˆã†ã¨ã—ã¦ã€ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«å…¥åŠ›ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã§ã€`USER-TOKEN`ã¨ã„ã†åå‰ã®Cookieã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚

```typescript:components/ui/input-key.tsx
import {useState, FC} from "react";
import {Button} from "@/components/ui/button";
import {Input} from "@/components/ui/input";
import {setTokenToCookie} from "@/lib/cookie";

export const InputKey: FC = (): JSX.Element => {
  const [inputKeyValue, setInputKeyValue] = useState<string>("");

  const handleInputKeyChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    setInputKeyValue(event.target.value);
  };

  const handleSaveKeyClick = () => {
    setTokenToCookie(inputKeyValue);
  };

  return (
    <div>
      <Input
        type="text"
        value={inputKeyValue}
        onChange={handleInputKeyChange}
        placeholder="Enter API KEY of APOD"
      />
      <Button
        onClick={handleSaveKeyClick}
      >
        Save
      </Button>
    </div>
  );
};
```

ã“ã“ã§ã¯`document.cookie`ã‚’ä½¿ã£ã¦Cookieã‚’ä¿å­˜ã—ã¾ã™ã€‚å®Ÿãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒä¸‹ã§globalãªAPIã§ã‚ã‚‹`document.cookie`ã‚’å‘¼ã³å‡ºã—ã¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
ï¼ˆãªã‚“ã‹ã‚‚ã£ã¨ã‚ˆã„ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ãªã„ã¨å›°ã‚‹æ“ä½œãŒä»–ã«ã‚ã‚Œã°ã€æ•™ãˆã¦ãã ã•ã„...ï¼‰

```typescript:lib/cookie.ts
export const setTokenToCookie = (
  value: string,
  options: CookieOptions = {}
): void => {
  const defaultOptions: CookieOptions = {
    path: "/",
    secure: true,
    sameSite: "Strict",
    maxAge: 3600, // in unit of seconds
    expires: new Date(Date.now() + 3600 * 1000), // 1æ™‚é–“å¾Œã«æœ‰åŠ¹æœŸé™ã‚’è¨­å®š
  };

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨å¼•æ•°ã§æŒ‡å®šã•ã‚ŒãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒãƒ¼ã‚¸
  const combinedOptions = {...defaultOptions, ...options};

  // Cookieã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ–‡å­—åˆ—å½¢å¼ã«å¤‰æ›
  const cookieString =
    `USER-TOKEN=${encodeURIComponent(value)};` +
    Object.entries(combinedOptions)
      .map(([key, val]) => {
        if (val === true) return key; // å€¤ãŒtrueã®å ´åˆã€å±æ€§åã ã‘ã‚’è¿½åŠ ï¼ˆä¾‹: 'Secure'ï¼‰
        if (key === "expires" && val instanceof Date) {
          return `${key}=${val.toUTCString()}`; // expiresã¯UTCå½¢å¼ã«å¤‰æ›
        }
        if (val !== undefined) return `${key}=${val}`; // å€¤ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¿½åŠ 
        return "";
      })
      .filter(Boolean) // ç©ºã®è¦ç´ ã‚’å‰Šé™¤
      .join("; ");

  // Cookieã‚’è¨­å®š
  document.cookie = cookieString;
};
```

### vitest ã®è¨­å®š

vitestã®browser modeã‚’ä½¿ã†ãŸã‚ã«ã¯ã€`vitest.config.ts`ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```typescript:vitest.config.ts
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    name: "browser",
    include: [
      "tests/browser/**/*.test.ts",
      "tests/browser/**/*.test.tsx",
    ],
    browser: {
      enabled: true,
      provider: 'playwright',
      instances: [
        {
          browser: 'chromium',
        },
      ],
    },
  },
})
```

å…ƒã€…ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§Node.jsç’°å¢ƒä¸‹ã§ã®ãƒ†ã‚¹ãƒˆã‚’è¡Œãªã£ã¦ã„ã‚‹å ´åˆã¯ã€[workspace](https://vitest.dev/guide/workspace.html)ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã€browser modeã®ãƒ†ã‚¹ãƒˆã‚’å…±å­˜ã•ã›ã‚‰ã‚Œã¾ã™ã€‚

```typescript:vitest.workspace.ts
import {defineWorkspace} from "vitest/config";

export default defineWorkspace([
  {
    extends: "vite.config.ts",
    test: {
      name: "unit",
      include: ["tests/unit/**/*.test.ts", "tests/unit/**/*.test.tsx"],
      globals: true,
      environment: "jsdom",
    },
  },
  {
    extends: "vite.config.ts",
    test: {
      name: "browser",
      include: [
        "tests/browser/**/*.test.ts",
        "tests/browser/**/*.test.tsx",
      ],
      browser: {
        enabled: true,
        provider: 'playwright',
        instances: [
          {
            browser: 'chromium',
          },
        ],
      },
    },
  },
]);
```

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«ã¯[vitest-browser-react](https://github.com/vitest-dev/vitest-browser-react)ã®`render`é–¢æ•°ã‚’ä½¿ã£ã¦ã€Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¯¾ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚„ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript
import {expect, describe, test} from "vitest";
import {render} from "vitest-browser-react";
import {userEvent} from "@vitest/browser/context";
import {InputKey} from "@/components/ui/input-key";

describe("InputKey Component", () => {
  test("ã‚­ãƒ¼å…¥åŠ›æ¬„ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨", () => {
    const component = render(<InputKey />);
    const inputField = component.getByPlaceholder("Enter TOKEN");
    expect(inputField).toBeVisible();
    expect(inputField).toBeEnabled();
  });

  test("ä¿å­˜ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨", () => {
    const component = render(<InputKey />);
    const saveButton = component.getByRole("button", {name: "Save"});
    expect(saveButton).toBeVisible();
    expect(saveButton).toBeEnabled();
  });

  test("ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã‚‹ã“ã¨", async () => {
    const component = render(<InputKey />);
    const inputField = component.getByPlaceholder("Enter TOKEN");
    const saveButton = component.getByRole("button", {name: "Save"});

    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’å…¥åŠ›ã—ã€ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    await userEvent.fill(inputField, "test-api-key");
    await userEvent.click(saveButton);

    // ãƒˆãƒ¼ã‚¯ãƒ³ãŒCookieã«ä¿å­˜ã•ã‚ŒãŸã‹ç¢ºèª
    expect(document.cookie).toContain("USER-TOKEN=test-api-key");
  });
});
```

## ãŠã‚ã‚Šã«

vitestã®browser modeã‚’ä½¿ã£ã¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚
å®Ÿéš›ã®ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã™ã‚‹ãŸã‚ã€ã€Œå®Ÿéš›ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ“ä½œã™ã‚‹ã€è¦–ç‚¹ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã—ãŸã€‚ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è²¬ä»»ç¯„å›²ï¼ˆã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã©ã†ã„ã†æŒ¯ã‚‹èˆã„ã‚’ã—ãªã„ã¨ã„ã‘ãªã„ã®ã‹ï¼‰ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦–ç‚¹ã‹ã‚‰æ‰ãˆã€ãã®çµæœã®ãƒ†ã‚¹ãƒˆè¦³ç‚¹ã¸ã®è½ã¨ã—è¾¼ã¿ï¼ˆãƒ†ã‚¹ãƒˆè¨­è¨ˆï¼‰ã‚’ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¨ã—ã¦è¡¨ç¾ã™ã‚‹ã“ã¨ãŒã—ã‚„ã™ã„ã¨æ„Ÿã˜ã¾ã—ãŸã€‚
ã¾ãŸã€å®Ÿéš›ã®ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã€å½é™½æ€§ã‚„å½é™°æ€§ã®ãƒªã‚¹ã‚¯ã‚’ä½æ¸›ã§ãã‚‹ç‚¹ã‚‚å¤§ããªãƒ¡ãƒªãƒƒãƒˆã§ã™ã€‚
