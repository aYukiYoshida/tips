---
title: "Gherkin記法はじめました"
emoji: "🥒"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["test", "Gherkin", "BDD", "TDD"]
published: true
---

## はじめに

End-To-Endでの、システム統合テストや受け入れテストに自動テストを導入するにあたって、Gherkinという、テスト記述の記法を知った。QAエンジニアの立場で、自動テストを導入する方法として、よさそうに感じたので、そのときに調べたことをこの記事にまとめる。人に読んでもらうものというよりも、メモに近い。

そもそも Gherkin は、Behavior-driven development (以下、BDD)という開発手法で使用されるテスティングフレームワークで用いられる記法である。また、BDDは、Test-driven development (以下、TDD)の派生である。まずは、そのTDD、BDDについて、簡単にまとめる。

## Test Driven Development

前提として、TDDとは開発手法もしくは設計手法の1つであり、テストの手法ではない。あくまでも「手段」としてテスト（テストコード）を用いた開発方法である。
テストファーストによる追加・変更と、リファクタリングによる設計改善の2つの活動を超短期で繰り返して開発を進めていく技法である。RED/GREEN/REFACTORのサイクルを回すとも表現される。これにより「素早くフィードバックを得る」という目的を達成する。具体的には、以下のように進める。

1. 失敗するテストコードを書く。このテストは、コードが求められる機能を表す。また、テストを実行可能にするために、テスト対象となるコードを実装する。ここでは、テストが実行可能になれば、どんなコードを実装してもよい。
2. テストが成功する様にテスト対象コードを変更する。
3. 別のテストケースの失敗するテストコードを追加する。
4. テストが成功する様にテスト対象コードを変更する。
5. テストが成功する状態を保ったままテスト対象コードをリファクタリングする。ここでのリファクタリングは、テストを動作させるためだけに作成された重複を全て取り除く作業になる。(REFACTOR)

TDDのアプローチ手法は、以下の2とおりある。それぞれProc/Consがある。[テスト駆動開発／振る舞い駆動開発を始めるための基礎知識](https://atmarkit.itmedia.co.jp/ait/articles/1403/05/news035.html)が参考になる。ここでは、流派の呼び方と、それぞれのバイブル的書籍を記載する。

- inside-out TDD: デトロイト派、古典派
  - バイブル: [テスト駆動開発](https://www.amazon.co.jp/%E3%83%86%E3%82%B9%E3%83%88%E9%A7%86%E5%8B%95%E9%96%8B%E7%99%BA-%EF%BC%AB%EF%BD%85%EF%BD%8E%EF%BD%94%EF%BC%A2%EF%BD%85%EF%BD%83%EF%BD%8B-ebook/dp/B077D2L69C)(Test Driven Development By Exampleの日本語訳版)
- outside-in TDD: ロンドン派、モック派
  - バイブル: [実践テスト駆動開発](https://www.amazon.co.jp/%E5%AE%9F%E8%B7%B5%E3%83%86%E3%82%B9%E3%83%88%E9%A7%86%E5%8B%95%E9%96%8B%E7%99%BA-Object-Oriented-SELECTION-Freeman/dp/4798124583)

以下は、TDDにおける原則や指標について記述する。

Kent BeckのいうTDDの原則 from『[テスト駆動開発](https://www.amazon.co.jp/%E3%83%86%E3%82%B9%E3%83%88%E9%A7%86%E5%8B%95%E9%96%8B%E7%99%BA-%EF%BC%AB%EF%BD%85%EF%BD%8E%EF%BD%94%EF%BC%A2%EF%BD%85%EF%BD%83%EF%BD%8B-ebook/dp/B077D2L69C)』

> 自動テストが失敗した場合だけ、新しいコードを書く。重複を取り除く。2つの規則はプログラミングのタスクにおける順番を意味する。
> レッド: 動作しないテストを少しだけ作成する。おそらく最初はコンパイルできない
> グリーン: テストをすぐに動作させる。そのためには、どのようなコードでもよい
> リファクタリング: テストを動作させるためだけに作成された重複を全て取り除く

Robert.C.MartinのいうTDDの原則 from 『[Clean Code](https://www.amazon.co.jp/Clean-Code-%E3%82%A2%E3%82%B8%E3%83%A3%E3%82%A4%E3%83%AB%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E9%81%94%E4%BA%BA%E3%81%AE%E6%8A%80-%E3%82%A2%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%89%E3%83%AF%E3%83%B3%E3%82%B4-%EF%BC%B2%EF%BD%8F%EF%BD%82%EF%BD%85%EF%BD%92%EF%BD%94-%EF%BC%A3%EF%BC%8E%EF%BC%AD%EF%BD%81%EF%BD%92%EF%BD%94%EF%BD%89%EF%BD%8E-ebook/dp/B078HYWY5X)』

> 3つの原則を守りながら実装を進める。
>
> 1. 失敗するテストができるまでプロダクトを書いてはいけない
> 2. 失敗するテストがある場合にはそれ以上テストを追加してはいけない
> 3. テストを成功させるプロダクトがある場合にはそれ以上プロダクトを追加してはいけない

TDD では、実装対象のユーザーの立場でテストする。ここでいうユーザーは、これから実装しようとしているものを使う人を指す。あるモジュールやクラスを実装しようとしているときは、そのモジュールやクラスを使う人が、ユーザーとなる。もっと上位のレイヤーであれば、エンドユーザーから見える機能になれば、エンドユーザーやプロダクトオーナーがユーザーとなる。ユーザーは実装対象によって異なる。

また、実装するテストコードは説明的で読みやすい文章であるべき。例えば、対象のメソッドに対する説明ではなく、「対象がどのような変化を生むのか」を書くべきである。

## Behavior Driven Development

BDDは、日本語では、「ふるまい駆動開発」などと訳される。Dan Northにより提唱された技法。詳しくは「[BDDの導入](https://digitalsoul.hatenadiary.org/entry/20090819/1250686015)」を参照すると良い。TDDを進めていく中で、「何をテストすべきか」「テストとは何か」といった問いに対しての説明として"Test"ではなく"Behavior"という言葉を使って説明する方が開発者にとって理解しやすかった、というDan Northの経験から生まれた。いわゆる「TDDのテストはテストではなく、そのコードが求められる機能を表す」という考えを理解しやすい様にする役割を持つ。[BDDの解釈についての記事](https://ukstudio.jp/BDD%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E8%87%AA%E5%88%86%E3%81%AA%E3%82%8A%E3%81%AB%E3%81%BE%E3%81%A8%E3%82%81%E3%81%A6%E3%81%BF%E3%81%9F/)は参考になる。

BDDは、アジャイルソフトウェア開発での技法のひとつで、エンジニアとQAエンジニアと非エンジニア(プロダクトマネージャ/オーナーやステークホルダー)間のコラボレーションを手助けする開発技法である。その要因は、テストがソフトウェアに期待される振る舞い(機能的な外部仕様)に特化した記述に基づいて行われることにある。これにより、ユーザーの要求やアーキテクチャの設計仕様といった、より上位のインプットとTDDのテストにつながりを持たせている。

## BDDフレームワーク

[Behat](https://github.com/Behat)の制作者であるKonstantin Kudryashovは、以下の[2つの相補的なBDDフレームワークを提唱](https://github.com/Behat/Behat/issues/92#issuecomment-5572021)している。

- SpecBDD
- StoryBDD

以下にそれぞれのフレームワークの役割を示す。

### SpecBDD

SpecBDDは、内部構造に寄った実装レベルの仕様を表現し、低レベルなテスト、いわゆる単体テストで用いられる。
代表的なフレームワークを以下に示す。

- [RSpec](http://rspec.info)
- [PHPSpec](http://phpspec.net)
- [Mocha](https://mochajs.org/)
- [NSpec](http://nspec.org)

以下に上記フレームワークでの一般的な記述例を示す。

```javascript:example.spec.js
describe("Authentication", () => {
  describe("in login page", () => {
    describe("with valid credentials", () => {
      it("should success to login", () => {
        // Arrange
        const user = new User("email", "password");
        // Act
        const success = user.login();
        // Assert
        expect(success).toBe(true);
      });
    });
  });
});
```

この記述の特長を以下に示す。

- `describe`のネストにより、テストのコンテキストを表現できる
  ネストされた`describe`の第一引数を一つの文として読み下すことで、テストのコンテキストを理解できる。上記の例では、`Authentication in login page with valid credentials`となる。
- `it`によるテスト記述
  上記の例では`it should success to login`と読み下すことができ、ソフトウェアの振る舞いをそのまま記述できる。

### StoryBDD

StoryBDDは、ScenarioBDDとも呼ばれ、ソフトウェアの機能性についてのふるまいをユーザー視点からシナリオとして表現する。このシナリオ自体はテストではなく、ビジネス面において興味深いものを除いて、すべてのアプリケーションの機能をターゲットにする目的もない。しかし、シナリオを用いて開発物の受け入れ段階のテストを自動化することができる。その際用いる代表的なフレームワークとして、[Cucumber](https://cucumber.io)がある。Cucumberでは、シナリオ記述に[Gerkin記法](https://cucumber.io/docs/guides/overview/#what-is-gherkin)を用いる。

## Gherkin 記法

ここからが本題のGherkin記法。
Gherkin記法とはシナリオ記述フォーマットの1つで、「こういう状態のとき、こういう動作を行えば、こうなることが期待される」という形式でシナリオを記述する。
以下の理由から非エンジニアでも、どんなことがテストされているかがわかりやすいのが特長。

- 自然言語を使用して記述する
- 仕様部分を独立して記述する
- とにかく構文が端的で平易な書き方になる

以下に簡単な例を示す。

```Gherkin:cucumber.feature
Feature: きゅうりを食べる
  # description
  人がきゅうりを食べるときの振る舞い
  Scenario: 数十本のきゅうりを食べるとお腹が満たさせる
    Given: 太郎は空腹である
    When: 太郎はきゅうりを50本食べる
    Then: 太郎は満腹になる
```

Gherkin記法では、キーワードと呼ばれる修飾子を用いて振る舞いを記述する。それぞれ以下の様な役割を持つ。詳細は[cucumberのリファレンス](https://cucumber.io/docs/gherkin/reference)を参照のこと。[日本語訳している記事](https://qiita.com/hideshis/items/b853f2a0ff4769f24cfb)もある。

- `Feature`: ソフトウェアの機能を記述。関連する`Scenario`をまとめる役割も持つ。
- `Scenario`: 機能に対する具体的なルールを説明する。以降に続く`Steps`の内容と一致する様に記述すること。
- `Steps`
  - `Given`:振る舞いまたはアクションを受け取るシステムの状態(前提条件)を記述する。
  - `When`: 最終結果を引き起こす振る舞いまたは実行内容を記述する。
  - `Then`: 所定の状態で所定の振る舞いによって引き起こされる結果(期待結果)を記述する。
  - `And`/`But`: 各ステップを連続して記述する場合に用いる

### シナリオを書くときの心構え

`Steps`の`Given`, `When`, `Then`のキーワードによる記述は、ユニットテストの、Arrange-Act-Assert (AAA)に構文が類似しているように感じる。AAAは、テストコードを「準備」「実行」「検証」に分けて、それぞれができるだけひとまとまりになって記述することで、テストコードが読みやすくなるという考え。`Steps`に記述する内容が、なにを示しているものなのか、それに相応しい修飾子を用いることが大切。

`Steps`に`And`や`But`のキーワードを多く用いて、長いシナリオを記述することができる。しかし、つらつらと長いシナリオを描くと、「結局、何をテストしているの？」など、シナリオの可読性が落ちる。結果的に、シナリオの保守性が下がる。保守性の高い状態でテストシナリオを記述する際に役立つ原則に「BRIEFの原則」がある。この原則について書かれた記事「[Keep your scenarios BRIEF](https://cucumber.io/blog/bdd/keep-your-scenarios-brief/)」が参考になる。[日本語訳版](https://nihonbuson.hatenadiary.jp/entry/keep-your-scenarios-brief)もある。

- B: Business language
  ビジネスチームのメンバーが明確に理解できるように、ビジネスドメインで用いられる言語を用いてシナリオを記述する。
  アンチパターン: さまざまなコンテキストでさまざまな意味を持つ用語を使用する(たとえば、アドレス、ユーザー、日付、アカウントなど)。
- R: Real data
  実際のデータを使用して、シナリオを作成する。
- I: Intention revealing
  意図を明らかにする。
  アンチパターン: シナリオ内にUIの用語を使用する(たとえば、ボタンをクリックする、リンクをたどるなど)。
- E: Essential
  シナリオの目的は、ルールがどのように振る舞うかを説明すること。この目的に直接関与しない部分は、削り落とし、本質的な部分のみで記述する。
- F: Focused
  1つのルールの説明に焦点を絞るべきである。
- Brief
  5行以下に制限することを推奨。これにより、読みやすくなり、意図を捉えるのもはるかに簡単になる。

ちなみに、Gherkin記法を用いるテスティングフレームワークを導入したからといって、そのチームがBDDの手法で開発していることになるわけではない。いうなれば、「BDDをサポートするテスティングフレームワーク」である。

## 参考になる記事

- [テスト駆動開発／振る舞い駆動開発を始めるための基礎知識](https://atmarkit.itmedia.co.jp/ait/articles/1403/05/news035.html)
- [TDD／BDDの思想とテスティングフレームワークの関係を整理しよう](https://atmarkit.itmedia.co.jp/ait/articles/1403/25/news033.html)

<!-- qiita article id: 8f9f8980c8364dc50909 -->
