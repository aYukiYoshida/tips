---
title: "ç›´å‰ã®å®Ÿè¡Œæ™‚ã«å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ã¿å†å®Ÿè¡Œ in Playwright"
emoji: "ðŸŽ­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["playwright", "typescript", "test", "web"]
published: true
---

:::message alert
(2024/05/07 è¿½è¨˜)
Playwright [v1.44.0](https://github.com/microsoft/playwright/releases/tag/v1.44.0) ã®ãƒªãƒªãƒ¼ã‚¹ã§ CLI ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã« `--last-failed` ãŒè¿½åŠ ã•ã‚ŒãŸã€‚ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚Œã°ã€ã€Œç›´å‰ã«å®Ÿè¡Œã—ãŸãƒ†ã‚¹ãƒˆã®çµæžœã‹ã‚‰å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ã¿ã‚’å†å®Ÿè¡Œã™ã‚‹ã€ã‚’å®Ÿç¾ã§ãã‚‹ã€‚
:::

## ã¯ã˜ã‚ã«

### å®Ÿç¾ã—ãŸã„ã“ã¨

[Playwright](https://playwright.dev/) ã§ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® [Retries](https://playwright.dev/docs/test-retries) ã®ãƒšãƒ¼ã‚¸ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«å®Ÿè¡Œä¸­ã«å¤±æ•—ã—ãŸã‚±ãƒ¼ã‚¹ã‚’å†å®Ÿè¡Œã™ã‚‹æ©Ÿèƒ½ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã€‚ã“ã®æ©Ÿèƒ½ã¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«ä½•ã‹ã—ã‚‰ã®è¦å› ã«ã‚ˆã£ã¦å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã€ã™ãªã‚ã¡ä¸å®‰å®šãªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’åŒã˜ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã®ãƒ—ãƒ­ã‚»ã‚¹ä¸­ã«å†å®Ÿè¡Œã™ã‚‹æ©Ÿèƒ½ã§ã‚ã‚‹ã€‚ã—ã‹ã—ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒå®Œäº†ã—ãŸçµæžœã€å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ã¿ã‚’å†åº¦å®Ÿè¡Œã™ã‚‹æ©Ÿèƒ½ã¯ Playwright ã§ã¯æä¾›ã•ã‚Œã¦ã„ãªã„ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€ç›´å‰ã«å®Ÿè¡Œã—ãŸãƒ†ã‚¹ãƒˆã®çµæžœã‹ã‚‰å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ã¿ã‚’å†å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã™ã‚‹ã€‚

### ä½¿ã„æ‰€

ä¾‹ãˆã°ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã¨ã™ã‚‹ã€‚ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«ã€ã“ã®å¿…è¦ãªãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒç”¨æ„ã§ãã¦ã„ãªã„ã€ã‚‚ã—ãã¯æ„å›³ã—ãŸã‚‚ã®ã«ãªã£ã¦ã„ãªã„å ´åˆã€ãã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¯å¤±æ•—ã™ã‚‹ã€‚ä»–ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«ã¯ã€ãã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¯ä¾å­˜ã—ãªã„ãŸã‚ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«å•é¡ŒãªãæˆåŠŸã™ã‚‹ã€‚ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æ¬ é™¥ã«æ°—ã¥ãã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£ã—ãŸå¾Œã«ã€ãã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ã¿ã‚’å†å®Ÿè¡Œã—ãŸã„ã¨ã„ã†å ´åˆã«ã€å‰è¿°ã®ã€Œä»¥å‰ã«å®Ÿè¡Œã—ãŸãƒ†ã‚¹ãƒˆã®çµæžœã‹ã‚‰å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ã¿ã‚’å†å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã€ãŒã‚ã‚‹ã¨ä¾¿åˆ©ã§ã‚ã‚‹ã€‚

## å®Ÿè£…

### Playwright ã§ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® [Command line](https://playwright.dev/docs/test-cli) ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€ä»¥ä¸‹ã®æŒ‡å®šæ–¹æ³•ãŒã‚ã‚‹ã€‚

- `filePath:lineNumber` ã®æŒ‡å®š

    ```shell
    npx playwright test my-spec.ts:42
    ```

- `testTitle` ã®æŒ‡å®š

    ```shell
    npx playwright test -g "add a todo item"
    ```

ä»Šå›žã¯ã²ã¨ã¤ç›®ã® `filePath:lineNumber` ã‚’æŒ‡å®šã™ã‚‹æ–¹æ³•ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

### ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã«ã‚ˆã‚‹å®Ÿè¡Œçµæžœã®ä¿å­˜

å‰è¿°ã® `filePath:lineNumber` ã®æƒ…å ±ã‚’ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«ä¿å­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚Playwright ã§ã¯ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæžœã‚’ãƒ¬ãƒãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜ã™ã‚‹æ©Ÿèƒ½ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã€‚ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæžœã‚’ä¿å­˜ã™ã‚‹ã€‚ãƒ¬ãƒãƒ¼ãƒˆã®å‡ºåŠ›ã«ã¯ã€ç‹¬è‡ªå®Ÿè£…ã—ãŸãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã”ã¨ã« `filePath:lineNumber` ã®æƒ…å ±ã¨ `outcome="expected"|"unexpected"|"skipped"|"flaky"` ã®æƒ…å ±ã‚’å«ã‚€é…åˆ—ã‚’ JSON å½¢å¼ã§å‡ºåŠ›ã™ã‚‹ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸã€‚ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã‚‹ã€‚

https://github.com/aYukiYoshida/playwright-simple-json-reporter

ãƒ¬ãƒãƒ¼ãƒˆã®å‡ºåŠ›ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã™ã€‚

```JSON
{
  "startedAt": 1713507478073,
  "durationInMs": 27545.525999999998,
  "status": "passed",
  "results": [
    {
      "id": "308f7d0e05acf652cf55-dff0c71519df34ca7ba8",
      "project": "setup",
      "location": "setup/login.setup.ts:22:5",
      "title": "Login and Setup as Bob",
      "outcome": "expected",
      "durationInMs": 5113
    },
    {
      "id": "884fc53766d15c58cb3b-f843d31e795e7fc28ff0",
      "project": "chrome",
      "location": "tests/chat.spec.ts:129:7",
      "title": "Send a chat message",
      "outcome": "expected",
      "durationInMs": 6602
    },
    {
      "id": "269790c8a8e01a6a79d9-a66c0172f374246b12a5",
      "project": "teardown",
      "location": "teardown/chat.teardown.ts:77:7",
      "title": "Delete chat messages",
      "outcome": "expected",
      "durationInMs": 10126
    }
  ]
}
```

### å®Ÿè¡Œã”ã¨ã«ãƒ¬ãƒãƒ¼ãƒˆã®å‡ºåŠ›å…ˆã‚’å¤‰æ›´ã™ã‚‹

Playwright ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã® [Issue#19010](https://github.com/microsoft/playwright/issues/19010) ã‚’å‚è€ƒã«ã—ã¦ã€å®Ÿè¡Œã—ãŸæ™‚åˆ»ã‚’ãƒ•ã‚©ãƒ«ãƒ€åã«å«ã‚ã¦ã€å®Ÿè¡Œã”ã¨ã«ãƒ¬ãƒãƒ¼ãƒˆã®å‡ºåŠ›å…ˆã‚’å¤‰æ›´ã™ã‚‹ã‚ˆã†ã«ã—ãŸã€‚
ã¾ãŸã€ä¸€æ„ã«æœ€æ–°ã®çµæžœã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã«ã€ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹ã‚ˆã†ã«ã—ãŸã€‚ã“ã“ã§ã¯ã€ãã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å‰²æ„›ã™ã‚‹ã€‚

```typescript:playwright.config.ts
import moment from "moment";
import { defineConfig } from "@playwright/test";

const reportFolder = `report/report-${moment().format("YYYY-MM-DD[T]HH-mm-ss")`;

export default defineConfig({
  reporter: [
    [
      "playwright-simple-json-reporter",
      {
        outputFolder: reportFolder,
        name: "result.json",
        testMatch: /.*\.spec\.ts/,
      },
    ],
  ],
});
```

### å‰å›žå¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ã¿ã‚’å†å®Ÿè¡Œã™ã‚‹

`outcome` ãŒ `unexpected` ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ã¿ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

```javascript
const report = JSON.parse(fs.readFileSync(latestReport).toString());
if (report.status !== "passed"){
  const targets = report.results.filter(
    (result) => result.outcome === "unexpected"
  ).map((result) => result.location);
  proc.execSync(`npm test -- ${targets.join(" ")} ${process.argv.slice(2).join(" ")}`, {stdio: 'inherit'});
} else {
  console.info("There is no failed test case in the latest report");
}
```

<!-- qiita article id: cabd4e84e069786b1e65 -->
