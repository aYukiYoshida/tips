---
title: "Playwright ã§ã®ãƒ†ã‚¹ãƒˆä¿¡é ¼æ€§å‘ä¸Š - ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç·¨"
emoji: "ğŸ­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["playwright", "typescript", "test", "testing", "web"]
published: true
---

## ã¯ã˜ã‚ã«

æœ€è¿‘Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®Playwrightã‚’ç”¨ã„ãŸE2Eãƒ†ã‚¹ãƒˆã®ãƒ†ã‚¹ãƒˆä¿¡é ¼æ€§ã‚’å‘ä¸Šã™ã‚‹ï¼ˆflakinessã‚’è§£æ¶ˆã™ã‚‹ï¼‰ãŸã‚ã«ã€ç”¨ã„ãŸæ‰‹æ³•ã‚’æœ¬è¨˜äº‹ã§ç´¹ä»‹ã—ã¾ã™ã€‚

## è§£æ¶ˆã—ãŸã‹ã£ãŸã“ã¨

Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ãã®å¾Œã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã¦ã„ã¾ã—ãŸã€‚ã“ã®ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã€ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€ç”»åƒè¦ç´ ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã«ã‚ˆã‚‹åˆ¤å®šã‚’ã—ã¦ã„ã¾ã—ãŸã€‚

```typescript
const [fileChooser] = await Promise.all([
  page.waitForEvent("filechooser"),
  page.getByRole("button", {name: "ç”»åƒã‚’é¸æŠ"}).click(),
]);
await fileChooser.setFiles("avatar-image.png");
await page.getByRole("button", { name: "ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰" }).click();

await expect(page.getByRole("img", { name: "avatar" })).toHaveScreenshot("expected-image.png");
```

ã¨ã“ã‚ãŒã€[`toHaveScreenshot`](https://playwright.dev/docs/api/class-locatorassertions#locator-assertions-to-have-screenshot-1) ã®åˆ¤å®šãŒã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãŒç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹å‰ã«å®Ÿè¡Œã•ã‚Œã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚Šã€ã¨ãã©ãå¤±æ•—ã—ã¦ã„ã¾ã—ãŸã€‚

## è§£æ¶ˆæ–¹æ³•

### ç”»åƒè¦ç´ ã®`src`å±æ€§ã‚’ç¢ºèªã™ã‚‹

ç”»åƒè¦ç´ ã®`src`å±æ€§ãŒã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã®URLã«å¤‰ã‚ã‚‹ã¾ã§å¾…ã¤ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
æ˜ç¤ºçš„ã«`src`å±æ€§ãŒå¤‰ã‚ã‚‹ã“ã¨ã‚’å¾…æ©Ÿã™ã‚‹ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹å¿…è¦ã¯ãªã[`toHaveAttribute`](https://playwright.dev/docs/api/class-locatorassertions#locator-assertions-to-have-attribute)ã§å±æ€§ãŒå¤‰ã‚ã‚‹ã¾ã§å¾…æ©Ÿã—ã¦ãã‚Œã¾ã™ï¼ˆ[auto-waiting](https://playwright.dev/docs/actionability#assertions)ã‚ã‚ŠãŒãŸã„ï¼‰ã€‚

```diff typescript
+await expect(page.getByRole("img", { name: "avatar" })).toHaveAttribute("src", /avatar-image\.png$/);
 await expect(page.getByRole("img", { name: "avatar" })).toHaveScreenshot("expected-image.png");
```

### ç”»åƒå–å¾—ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¾…æ©Ÿã™ã‚‹

å¯¾è±¡ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã«ç”»åƒã‚’å–å¾—ã™ã‚‹ãŸã‚ã®APIã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã—ãŸã€‚ãã“ã§ã€ç”»åƒå–å¾—ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```diff typescript
- await fileChooser.setFiles("avatar-image.png");
- await page.getByRole("button", { name: "ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰" }).click();
+ await Promise.all([
+  page.waitForResponse((response) =>
+    response.url().match("/\/api\/images\/avatar-image\.png$") &&
+    response.request().method() === "GET" &&
+    response.status() === 200
+  ),
+  await fileChooser.setFiles("avatar-image.png"),
+  await page.getByRole("button", { name: "ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰" }).click(),
+ ]);
```

## æœ€çµ‚çš„ãªã‚³ãƒ¼ãƒ‰

```typescript
const [fileChooser] = await Promise.all([
  page.waitForEvent("filechooser"),
  page.getByRole("button", {name: "ç”»åƒã‚’é¸æŠ"}).click(),
]);
await Promise.all([
  page.waitForResponse((response) =>
    response.url().match("/\/api\/images\/avatar-image\.png$") &&
    response.request().method() === "GET" &&
    response.status() === 200
  ),
  await fileChooser.setFiles("avatar-image.png"),
  await page.getByRole("button", { name: "ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰" }).click(),
]);
await expect(page.getByRole("img", { name: "avatar" })).toHaveAttribute("src", /avatar-image\.png$/);
await expect(page.getByRole("img", { name: "avatar" })).toHaveScreenshot("expected-image.png");
```

## ãŠã‚ã‚Šã«

ä»¥ä¸Šã€Playwrightã§ã®ãƒ†ã‚¹ãƒˆä¿¡é ¼æ€§å‘ä¸Šã®ãŸã‚ã«è¡Œã£ãŸã“ã¨ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚ç”»åƒã®åæ˜ å¾…ã¡ã¯ã€ã‚ˆãã‚ã‚‹èª²é¡Œã‹ã¨æ€ã„ã¾ã™ã®ã§ã€åŒã˜ã‚ˆã†ãªèª²é¡Œã‚’æŠ±ãˆã¦ã„ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
