---
title: "Appiumã§Androidã®Toastã‚’ç„¡ç†ã‚„ã‚Šå–å¾—ã™ã‚‹"
emoji: "ğŸ“±"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Appium", "Android", "test"]
published: true
---

## ã¯ã˜ã‚ã«

Appiumã‚’ä½¿ç”¨ã—ã¦Androidã‚¢ãƒ—ãƒªã®ãƒ†ã‚¹ãƒˆã‚’è¡Œã†éš›ã€Toastã®è¦ç´ ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã§ããªã„ã¨ã„ã†å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚
ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«Toastã®è¦ç´ ã®è¡¨ç¤ºã‚’ç¢ºèªã—ã‚ˆã†ã¨ã—ã¦ã‚‚`selenium.common.exceptions.StaleElementReferenceException`ãŒç™ºç”Ÿã—ã¾ã™ã€‚

```python
from appium.webdriver.common.appiumby import AppiumBy
from selenium.webdriver.support.wait import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

element = WebDriverWait(driver, 10).until(
EC.presence_of_element_located((AppiumBy.XPATH, './/android.widget.Toast[@text="message")))
assert element.get_attribute("displayed") == "true"
```

ã“ã®ã¨ãã€Toastã®è¦ç´ ã¯`driver.page_source`ã«ã¯ã€å«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¦ã„ã¾ã™ã€‚

## Toastã®è¦ç´ ã®å–å¾—æ–¹æ³•ã®ææ¡ˆ

`driver.page_source`ã®xmlã‚’ç›´æ¥è§£æã™ã‚‹ã“ã¨ã§ã€Toastã®è¦ç´ ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã‚’ææ¡ˆã—ã¾ã™ã€‚
ã¾ãšã€`WebDriverWait`ã‚’ä½¿ç”¨ã—ã¦ã€Toastã®è¦ç´ ãŒ`page_source`å†…ã«å‡ºç¾ã¾ã§å¾…æ©Ÿã—ã€Toastã®è¦ç´ ã‚’`driver.page_source`ã‹ã‚‰æŠ½å‡ºã—ã¾ã™ã€‚xmlã®è§£æã«ã¯[`xml.etree.ElementTree`](https://docs.python.org/ja/3/library/xml.etree.elementtree.html)ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```python
from xml.etree import ElementTree as ET

def presence_of_element_in_source(locator: Locator) -> Callable[[WebDriver], ET.Element]:
    def predicate(driver: WebDriver) -> ET.Element:
        element = ET.fromstring(driver.page_source).find(locator.value)
        if element is None:
            raise NoSuchElementException(f"Element with {locator} is not found in the page source.")
        return element

    return predicate

def find_element_from_source(locator: Locator, timeout: float) -> ET.Element:
    """Find an element in the page source."""
    if locator.strategy != AppiumBy.XPATH:
        raise ValueError(f"Locator strategy must be {AppiumBy.XPATH}, but got {locator.strategy}")
    try:
        return WebDriverWait(driver, timeout).until(presence_of_element_in_source(locator), timeout=timeout)
    except TimeoutException:
        raise NoSuchElementException(f"Element with {locator} is not found in the page source.")
```

å–å¾—ã—ãŸToastè¦ç´ ã¯[`ET.Element`](https://docs.python.org/ja/3/library/xml.etree.elementtree.html#xml.etree.ElementTree.Element)ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚Šã€`get()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦å±æ€§ã‚’å–å¾—ã§ãã¾ã™ã€‚

```python
>>> print(element.attrib)
{'index': '1', 'package': 'com.android.settings', 'class': 'android.widget.Toast', 'text': 'message', 'displayed': 'true'}
>>> element.get("displayed")
'true'
```

`displayed`å±æ€§ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã€Toastã®è¦ç´ ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```python
toast: ET.Element = find_element_from_source((AppiumBy.XPATH, './/android.widget.Toast[@text="message"]'), timeout=10)
assert element.get("displayed") == "true"
```

## ã¾ã¨ã‚

ã“ã®æ–¹æ³•ã«ã‚ˆã‚Šã€Appiumã‚’ä½¿ç”¨ã—ã¦Androidã‚¢ãƒ—ãƒªã®Toastè¦ç´ ã‚’ç„¡ç†ã‚„ã‚Šå–å¾—ã—ã€è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
